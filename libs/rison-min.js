!function(r,e){"function"==typeof define&&define.amd?define(["exports"],e):e("object"==typeof exports?exports:r.rison={})}(this,function(r){var e=r;"undefined"==typeof e&&(window.rison={}),e.uri_ok={"~":!0,"!":!0,"*":!0,"(":!0,")":!0,"-":!0,_:!0,".":!0,",":!0,":":!0,"@":!0,$:!0,"'":!0,"/":!0},function(){for(var r=[],n=0;16>n;n++)for(var t=0;16>t;t++)if(n+t!==0){var i=String.fromCharCode(16*n+t);/\w|[-_.\/~]/.test(i)||r.push("\\u00"+n.toString(16)+t.toString(16))}e.not_idchar=r.join("")}(),e.not_idchar=" '!:(),*@$",e.not_idstart="-0123456789",function(){var r="[^"+e.not_idstart+e.not_idchar+"][^"+e.not_idchar+"]*";e.id_ok=new RegExp("^"+r+"$"),e.next_id=new RegExp(r,"g")}(),e.quote=function(r){return/^[-A-Za-z0-9~!*()_.',:@$\/]*$/.test(r)?r:encodeURIComponent(r).replace(/%2C/g,",").replace(/%3A/g,":").replace(/%40/g,"@").replace(/%24/g,"$").replace(/%2F/g,"/").replace(/%20/g,"+")},function(){var r={"'":!0,"!":!0},n=function(r){r&&"function"==typeof r.toJSON&&(r=r.toJSON());var e=t[typeof r];return e?e(r):void 0},t={array:function(r){var e,t,i,o=["!("],s=r.length;for(t=0;s>t;t+=1)i=n(r[t]),"string"==typeof i&&(e&&(o[o.length]=","),o[o.length]=i,e=!0);return o[o.length]=")",o.join("")},"boolean":function(r){return r?"!t":"!f"},"null":function(){return"!n"},number:function(r){return isFinite(r)?String(r).replace(/\+/,""):"!n"},object:function(r){if(r){if(r instanceof Array)return t.array(r);if("object"==typeof r.__prototype__&&"undefined"!=typeof r.__prototype__.encode_rison)return r.encode_rison();var e,i,o,s,a,u=["("],f=[];for(i in r)f[f.length]=i;for(f.sort(),a=0;a<f.length;a++)i=f[a],o=n(r[i]),"string"==typeof o&&(e&&(u[u.length]=","),s=isNaN(parseInt(i))?t.string(i):t.number(i),u.push(s,":",o),e=!0);return u[u.length]=")",u.join("")}return"!n"},string:function(n){return""===n?"''":e.id_ok.test(n)?n:(n=n.replace(/(['!])/g,function(e,n){return r[n]?"!"+n:n}),"'"+n+"'")},undefined:function(){}};e.encode=function(r){return n(r)},e.encode_object=function(r){if("object"!=typeof r||null===r||r instanceof Array)throw new Error("rison.encode_object expects an object argument");var e=t[typeof r](r);return e.substring(1,e.length-1)},e.encode_array=function(r){if(!(r instanceof Array))throw new Error("rison.encode_array expects an array argument");var e=t[typeof r](r);return e.substring(2,e.length-1)},e.encode_uri=function(r){return e.quote(t[typeof r](r))}}(),e.decode=function(r){var n=function(r){throw Error("rison decoder error: "+r)},t=new e.parser(n);return t.parse(r)},e.decode_object=function(r){return e.decode("("+r+")")},e.decode_array=function(r){return e.decode("!("+r+")")},e.parser=function(r){this.errorHandler=r},e.parser.WHITESPACE="",e.parser.prototype.setOptions=function(r){r.errorHandler&&(this.errorHandler=r.errorHandler)},e.parser.prototype.parse=function(r){this.string=r,this.index=0,this.message=null;var n=this.readValue();return!this.message&&this.next()&&(n=this.error("unable to parse string as rison: '"+e.encode(r)+"'")),this.message&&this.errorHandler&&this.errorHandler(this.message,this.index),n},e.parser.prototype.error=function(r){return"undefined"!=typeof console&&console.log("rison parser error: ",r),void(this.message=r)},e.parser.prototype.readValue=function(){var r=this.next(),n=r&&this.table[r];if(n)return n.apply(this);var t=this.string,i=this.index-1;e.next_id.lastIndex=i;var o=e.next_id.exec(t);if(o.length>0){var s=o[0];return this.index=i+s.length,s}return r?this.error("invalid character: '"+r+"'"):this.error("empty expression")},e.parser.parse_array=function(r){for(var e,n=[];")"!==(e=r.next());){if(!e)return r.error("unmatched '!('");if(n.length)","!==e&&r.error("missing ','");else{if(","===e)return r.error("extra ','");--r.index}var t=r.readValue();if("undefined"==typeof t)return void 0;n.push(t)}return n},e.parser.bangs={t:!0,f:!1,n:null,"(":e.parser.parse_array},e.parser.prototype.table={"!":function(){var r=this.string,n=r.charAt(this.index++);if(!n)return this.error('"!" at end of input');var t=e.parser.bangs[n];return"function"==typeof t?t.call(null,this):"undefined"==typeof t?this.error('unknown literal: "!'+n+'"'):t},"(":function(){for(var r,e={},n=0;")"!==(r=this.next());){if(n)","!==r&&this.error("missing ','");else{if(","===r)return this.error("extra ','");--this.index}var t=this.readValue();if("undefined"==typeof t)return void 0;if(":"!==this.next())return this.error("missing ':'");var i=this.readValue();if("undefined"==typeof i)return void 0;e[t]=i,n++}return e},"'":function(){for(var r,e=this.string,n=this.index,t=n,i=[];"'"!==(r=e.charAt(n++));){if(!r)return this.error('unmatched "\'"');if("!"===r){if(n-1>t&&i.push(e.slice(t,n-1)),r=e.charAt(n++),!("!'".indexOf(r)>=0))return this.error('invalid string escape: "!'+r+'"');i.push(r),t=n}}return n-1>t&&i.push(e.slice(t,n-1)),this.index=n,1===i.length?i[0]:i.join("")},"-":function(){var r=this.string,e=this.index,n=e-1,t="int",i="-",o={"int+.":"frac","int+e":"exp","frac+e":"exp"};do{var s=r.charAt(e++);if(!s)break;s>="0"&&"9">=s||(i.indexOf(s)>=0?i="":(t=o[t+"+"+s.toLowerCase()],"exp"===t&&(i="-")))}while(t);return this.index=--e,r=r.slice(n,e),"-"===r?this.error("invalid number"):Number(r)}},function(r){for(var e=0;9>=e;e++)r[String(e)]=r["-"]}(e.parser.prototype.table),e.parser.prototype.next=function(){var r,n=this.string,t=this.index;do{if(t===n.length)return void 0;r=n.charAt(t++)}while(e.parser.WHITESPACE.indexOf(r)>=0);return this.index=t,r}});